# Device-hop

This repository contains the parallel_for library and source-to-source translator that was used in the paper "Device-Hopping: Transparent Mid-Kernel Runtime Switching for Heterogeneous Systems", Metzger P., Seeker V., Fensch C., Cole M., to be published in ACM TACO.

The build.sh script creates a directory for build files, generates migratable CUDA, OpenCL, and OpenMP code from the high-level benchmark implementations with our parallel_for, builds the benchmarks, and sets up IPC.

Caution:
- The build script creates files in /dev/shm for IPC.
- One some installation the message queue size has to be changed with echo 1048576 > /proc/sys/fs/mqueue/msgsize_max

## Directory structure
| Directory | Description |
|:---|:---|
| benchmarks | Contains the high_level benchmark implementations with our parallel_for in separate .cpp files. The source-to-source translator will place its outputs also in this directory. Generated files are prefixed with _generated or are stored in "opencl_files", which will be created by the script that translates the benchmarks. |
| daemon | Source code of the daemon. |
| device_hopper | Contains the header library. The applications generated by the source-to-source translator use the code in this directory. |
| source_to_source_translator | Source code of the translator. |
| utils | Utilities, that, among other things, set up IPC and generate inputs for Rodinia NN and SHOC SPMV. |

## Usage
The scripts run_benchmarks.sh and run_daemon.sh illustrate how to use the daemon with the SHOC FFT benchmark.
First start the daemon with run_daemon.sh and then the benchmarks with run_benchmarks.sh.
Monitor the output of run_daemon.sh. The outputs of the benchmarks will appear here because they are run by the daemon.

WARNING: run_daemon.sh kills all processes that start with "plasticd" and deletes and creates files in /dev/shm for IPC.

## Dependencies
- Boost libraries:
  - asio/ip/host_name
  - crc
  - program_options
  - special_functions/next.hpp
- CUDA
- Intel's C/C++ compiler (ICC).- install IntelÂ® oneAPI HPC Toolkit

Modifications from the repo:
1) In the run_benchmarks.sh=>--path-to-library=/home/paul/phd/my_papers/plasticity/library to --path-to-library=<path to local directory>
2) In device_hopper/core.h => "/library/programming_model/benchmarks/opencl_files/" to "/benchmarks/opencl_files/"
3) In source_to_source_translator/template.h => "/programming_model/benchmarks/opencl_files/" to "/benchmarks/opencl_files/"
4) In benchmarks/shoc_ifft.cpp => "/library/" + "/plasticity/opencl_files/shoc_fft.cl" to "/benchmarks/shoc_src/shoc_fft.cl"
5) Create new empty directory "/input/benchmarks/input_data/" for storing generated files
6) In benchmarks/shoc_spmv_scalar.cpp => "/library/benchmarks/input_data/" to "/input/benchmarks/input_data/"

Step to generate smpv files:
1) cd cmake-build-debug/utils/
2) run "./spmv_gen_matrices --preccision <SINGLE or DOUBLE> --problem-size <size> --path-to-library <path to input directory from step 5 above>"

To run Benchmarks:
1) In the run_benchmarks.sh change to the benchmark .so file in "/cmake-build-debug/benchmarks/libgenerated_<benchmark>.so"

OUTPUT LOG(all units in ms):

CPU - OpenCL kernel compilation: compilation time
CPU - Clean up:                  
CPU - Kernel:                    CPU kernel execution time
CPU - Waiting:                   
CPU - Time in clWait:            
CPU - Setup in ROI:              
GPU - OpenCL kernel compilation: 
GPU - Clean up:                  
GPU - Kernel:                    
GPU - Waiting:                   
GPU - Time in clWait:            
GPU - Setup in ROI:              
Daemon startup:                  